{"version":3,"file":"client.js","sourceRoot":"","sources":["../../../src/rsc/router/client.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Copyright © 2024 650 Industries.\n * Copyright © 2024 2023 Daishi Kato\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * https://github.com/dai-shi/waku/blob/3d1cc7d714b67b142c847e879c30f0724fc457a7/packages/waku/src/router/client.ts#L1\n */\n\n'use client';\n\nimport { createElement, createContext, useState, Fragment } from 'react';\nimport type { ComponentProps, FunctionComponent, ReactNode } from 'react';\n\nimport { PARAM_KEY_SKIP, getComponentIds, getInputString } from './common.js';\nimport type { RouteProps } from './common.js';\nimport { Root, Slot, useRefetch } from './host.js';\n\nconst parseRoute = (url: URL): RouteProps => {\n  const { pathname, searchParams } = url;\n  if (searchParams.has(PARAM_KEY_SKIP)) {\n    console.warn(`The search param \"${PARAM_KEY_SKIP}\" is reserved`);\n  }\n  return { path: pathname, searchParams };\n};\n\nconst getHref = () =>\n  process.env.EXPO_OS === 'web'\n    ? window.location.href\n    : // TODO: This is hardcoded on native to simplify the initial PR.\n      'http://localhost:8081/';\n\nconst RouterContext = createContext<{\n  route: RouteProps;\n} | null>(null);\n\nfunction InnerRouter() {\n  const refetch = useRefetch();\n  const [route] = useState(() => parseRoute(new URL(getHref())));\n  const componentIds = getComponentIds(route.path);\n\n  // TODO: strip when \"is exporting\".\n  if (process.env.NODE_ENV === 'development') {\n    const refetchRoute = () => {\n      const loc = parseRoute(new URL(getHref()));\n      const input = getInputString(loc.path);\n      refetch(input, loc.searchParams);\n    };\n    globalThis.__EXPO_RSC_RELOAD_LISTENERS__ ||= [];\n    const index = globalThis.__EXPO_RSC_RELOAD_LISTENERS__.indexOf(\n      globalThis.__EXPO_REFETCH_ROUTE__\n    );\n    if (index !== -1) {\n      globalThis.__EXPO_RSC_RELOAD_LISTENERS__.splice(index, 1, refetchRoute);\n    } else {\n      globalThis.__EXPO_RSC_RELOAD_LISTENERS__.unshift(refetchRoute);\n    }\n    globalThis.__EXPO_REFETCH_ROUTE__ = refetchRoute;\n  }\n\n  return createElement(\n    RouterContext.Provider,\n    { value: { route } },\n    componentIds.reduceRight<null | ReactNode>(\n      (acc: ReactNode, id) => createElement(Slot, { id, fallback: acc }, acc),\n      null\n    )\n  );\n}\n\nexport function Router() {\n  const route = parseRoute(new URL(getHref()));\n  const initialInput = getInputString(route.path);\n  const initialSearchParamsString = route.searchParams.toString();\n  const unstable_onFetchData = () => {};\n  return createElement(\n    Root as FunctionComponent<Omit<ComponentProps<typeof Root>, 'children'>>,\n    { initialInput, initialSearchParamsString, unstable_onFetchData },\n    createElement(InnerRouter)\n  );\n}\n\n/**\n * ServerRouter for SSR\n * This is not a public API.\n */\nexport function ServerRouter({ children, route }: { children: ReactNode; route: RouteProps }) {\n  return createElement(\n    Fragment,\n    null,\n    createElement(\n      RouterContext.Provider,\n      {\n        value: {\n          route,\n        },\n      },\n      children\n    )\n  );\n}\n"]}